name: management
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  #schedule:
  #  - cron: '45 */1 * * *'
  workflow_run:
    workflows: ["sb config verification"]  # æŒ‡å®šä¾èµ–çš„å·¥ä½œæµåç§°
    types:
      - completed  # åªåœ¨å·¥ä½œæµå®Œæˆæ—¶è§¦å‘
jobs:
  management:
    runs-on: ubuntu-latest
    outputs:
      recent_files: ${{ steps.find-files.outputs.recent_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: Find files modified within last hour
        id: find-files
        run: |
          current_time=$(date +%s)
          one_hour_ago=$((current_time - 259000))
          target_dir="sub"
      
          temp_file=$(mktemp)
          find "$target_dir" -type f \( \
            -name "f*.json" -o \
            -name "k*.json" -o \
            -name "sk*.json" \
          \) -print0 | while IFS= read -r -d '' file; do
            commit_time=$(git log -1 --format="%ct" -- "$file")
            
            if [ -n "$commit_time" ] && [ "$commit_time" -ge "$one_hour_ago" ]; then
              echo "$file" >> "$temp_file"
              echo "ğŸŸ¢ æœ€è¿‘ä¿®æ”¹: $file ($(date -d @$commit_time '+%Y-%m-%d %H:%M:%S UTC'))"
            fi
          done
          # å…³é”®ä¿®æ”¹ç‚¹ï¼šç›´æ¥æ£€æŸ¥æ–‡ä»¶å†…å®¹
          if [ -s "$temp_file" ]; then
            echo "æ‰¾åˆ°ä»¥ä¸‹æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶:"
            cat "$temp_file"
            echo "recent_files=$(cat $temp_file | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°æœ€è¿‘ä¸€å°æ—¶ä¿®æ”¹çš„æ–‡ä»¶"
          fi
          rm "$temp_file"

      - name: Update sub.txt
        if: ${{ steps.find-files.outputs.recent_files }}
        run: |
          # å»é™¤å¤šä½™å¼•å·å¹¶è½¬æ¢æ ¼å¼
          echo '${{ steps.find-files.outputs.recent_files }}' | jq -r 'join("\n")' > sub/sub.txt

      - name: list newly updated files
        run: |
          cd ./sub
          pwd
          echo "Generated at: $(date)" >> sub.txt  # æ·»åŠ æ—¶é—´æˆ³ä½œä¸ºå†…å®¹
          #find . -type f \( -iname "f*.json" -o -iname "k*.json" -o \( -iname "s*.json" -a ! -iname "spl*.json" \) \) -mmin -60 >> sub.txt
          #cat sub.txt
        continue-on-error: true      
      - name: Cleanup old files
        if: ${{ steps.find-files.outputs.recent_files }}  # ä»…åœ¨å‘ç°æ–°æ–‡ä»¶æ—¶æ‰§è¡Œ
        run: |
          #cd sub  # æ ¹æ®ä½ çš„ç›®å½•ç»“æ„è°ƒæ•´          
          # æ­¥éª¤1ï¼šåˆ›å»ºä¿ç•™æ–‡ä»¶åˆ—è¡¨
          echo "ä¿ç•™æ–‡ä»¶åˆ—è¡¨ï¼š"
          echo '${{ steps.find-files.outputs.recent_files }}' | jq -r '.[]'
          echo '${{ steps.find-files.outputs.recent_files }}' | jq -r '.[]' > keep_files.txt
          #find . -type f \( -name "f*.json" \) >> keep_files.txt
          echo "providers.json" >> keep_files.txt
          
          # æ­¥éª¤2ï¼šæŸ¥æ‰¾æ‰€æœ‰ç›®æ ‡æ–‡ä»¶
          find . -type f \( -name "f*.json" -o -name "k*.json"  -o -name "sk*.json*" -o -name "spl*" \) > all_files.txt
      
          # æ­¥éª¤3ï¼šç”Ÿæˆåˆ é™¤åˆ—è¡¨ï¼ˆæ’é™¤ä¿ç•™æ–‡ä»¶ï¼‰
          grep -v -F -f keep_files.txt all_files.txt > delete_files.txt

          target_dir="sub"
          # æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼Œå¹¶ç­›é€‰å‡ºè¡Œæ•°å°äº220çš„æ–‡ä»¶
          find "$target_dir" -type f \( \
              -name "f*.json" -o \
              -name "k*.json" -o \
              -name "sk*.json" \
          \) | while read -r file; do
              # ç»Ÿè®¡æ–‡ä»¶è¡Œæ•°
              line_count=$(wc -l < "$file")
              # åˆ¤æ–­è¡Œæ•°æ˜¯å¦å°äº220
              if (( line_count < 220 )); then
                  echo "$file" >> delete_files.txt
                  sed -i "/$(echo "$file" | sed 's/[\/&]/\\&/g')/d" sub/sub.txt
              fi
          done
      
          # å®‰å…¨éªŒè¯ï¼ˆè°ƒè¯•è¾“å‡ºï¼‰
          echo "å°†è¦åˆ é™¤çš„æ–‡ä»¶ï¼š"
          cat delete_files.txt || echo "æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ–‡ä»¶"
      
          # æ­¥éª¤4ï¼šæ‰§è¡Œåˆ é™¤ï¼ˆå¸¦ç¡®è®¤ä¿æŠ¤ï¼‰
          if [ -s delete_files.txt ]; then
            echo "æ­£åœ¨åˆ é™¤æ—§æ–‡ä»¶..."
            xargs -a delete_files.txt rm -v
          else
            echo "æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ–‡ä»¶"
          fi
      
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          rm -f keep_files.txt all_files.txt delete_files.txt
        continue-on-error: true      

      - name: Git Setup
        run: |
          git config --global user.email "wanghz518@gmail.com"
          git config --global user.name "shenmyisi"

      - name: Check for changes
        id: verify_diff
        run: |
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes_exist=true" >> $GITHUB_OUTPUT
          else
            echo "changes_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push
        if: steps.verify_diff.outputs.changes_exist == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update files"
          file_pattern: '*'    # æˆ–ç›´æ¥çœç•¥ file_pattern å‚æ•°
